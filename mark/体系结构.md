

## 动态流水线

#### 静态流水线的缺点

都在译码阶段解决数据相关性，如果一条指令发生了阻塞，那么后面的指令都需要等待，即使它和前面的指令没有数据相关性。

#### 基本思想

- 前面指令等待不影响后续指令
- 将相关的解决向后拖

#### 将译码分成2个部分

- 发射： 指令译码，检查结构相关
- 读操作数：准备好就读，不然就等待

#### 乱序执行的基本做法

- 指令进入是有序的
- 指令可以乱序执行，只要没有相关就可以执行，多条指令同时执行
- 结束也是有序的

#### Tomasulo算法

- 通过寄存器重命名消除`WAW` `WAR`相关

##### 流水线阶段

1. 发射

    把操作队列的指令根据操作类型送到保留站(保留站不满)，发射过程中读寄存器的值和结果状态域

2. 执行

    如果所需操作数准备好就执行，否则监听结果总线并接受总线的值

3. 写回

    把结果送到结果总线，释放保留站

##### 精确列外处理

##### 把后面指令对机器状态的修改放在前面指令都执行完之后

##### 采用缓冲器保存执行结果，当前面指令都执行完了再把缓冲器中的结果写到寄存器或者存储器

- 在流水线修改机器状态时写到缓冲器
- 增加提交阶段，把缓冲器中的内存写回寄存器或者存储器
- 提交阶段只有在前面指令都执行完成后才能执行
- 有序提交： 乱序执行，有序提交
- Reorder buffer ROB

#### ROB

- 内容：目标地址，值，操作类型
- 写回时写入ROB，后面指令可能从ROB读操作数
- 使用ROB作为重命名号
- 提交把缓冲器中的内容写回寄存器或者存储器

##### 保留站将指令顺序打乱，ROB将指令顺序再次恢复





## CACHE

### 特征

- Cache是主存的一个子集
- Cache没有程序上的意义 -> Cache是硬件维护的

### 结构特点

- 同时存储数据和地址
- 考虑所需的数据在不在Cache中

### Cache类型

- 全相联
- 组相连
- 直接相连

### 写命中策略

- 写穿透

    - 写cache的同时写内存

    - 内存里的数据永远是最新的，cache替换时直接扔掉
    - 只需有效位

- 写回

    - 只写cache不写内存
    - 替换时需要把cache写回内存
    - 需要脏位和有效位

- 写回/写穿透

    - L1到L2用写穿透，L2速度较快
    - L2到内存用写回，内存太慢了

### 写失效策略

- 写分配

    - 先把失效块读到cache，再在cache中写

    - 在写命中时采用写回策略的cache中使用

- 写不分配

    - 直接写入内存

    - 在写命中时采用写穿透策略的cache中使用

### Cache性能分析

- 降低失效率
- 降低失效延迟
- 降低命中延迟

#### 降低失效率

- 增加块大小
    - 降低冷失效
    - Cache容量不变的情况下，导致cache行数变少，增加冲突
- 增加Cache容量
    - 大了就快不了
- 路预测
- 软件优化

#### 失效类型

- 冷失效
- 容量失效
- 冲突失效
- 一致性失效
