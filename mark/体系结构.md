

## 动态流水线

**单车道可以超车**

### 程序的相关性

- 数据相关: RAW(真相关)

- 名字相关: WAR WAW

    寄存器重命名

- 控制相关

- 引起流水线阻塞

    1. 编译调度: 循环展开
    2. 乱序执行: 等待的指令不影响其他指令的执行

### 编译器静态调度

- 分析指令之间的相关性，避免由于相关导致的阻塞。
    - 相关不一定阻塞，只要隔得够远

### 硬件动态调度

#### 将译码分成2个部分

- 发射： 指令译码，检查结构相关
- 读操作数：准备好就读，不然就等待

#### 乱序执行的基本做法

- 指令进入是有序的
- 指令可以乱序执行，只要没有相关就可以执行，多条指令同时执行
- 结束也是有序的

#### Tomasulo算法

- 通过寄存器重命名消除`WAW` `WAR`相关

##### 流水线阶段

1. 发射

    把操作队列的指令根据操作类型送到保留站(保留站不满)，发射过程中读寄存器的值和结果状态域

2. 执行

    如果所需操作数准备好就执行，否则监听结果总线并接受总线的值

3. 写回

    把结果送到结果总线，释放保留站

##### 精确列外处理

##### 把后面指令对机器状态的修改放在前面指令都执行完之后

##### 采用缓冲器保存执行结果，当前面指令都执行完了再把缓冲器中的结果写到寄存器或者存储器

- 在流水线修改机器状态时写到缓冲器
- 增加提交阶段，把缓冲器中的内存写回寄存器或者存储器
- 提交阶段只有在前面指令都执行完成后才能执行
- 有序提交： 乱序执行，有序提交
- Reorder buffer ROB

#### ROB

- 内容：目标地址，值，操作类型
- 写回时写入ROB，后面指令可能从ROB读操作数
- 使用ROB作为重命名号
- 提交把缓冲器中的内容写回寄存器或者存储器

##### 保留站将指令顺序打乱，ROB将指令顺序再次恢复

## 多发射数据通路

### 指令集并行关键技术

- 指令流水线

- 多发射：空间重复

- 乱序执行

    - 动态调度: 前面指令因为相关而等待时，后续指令可以继续执行

    - 转移猜测
    - 非阻塞访存

### 保留站组织

- 独立保留站: 每一个功能部件一个保留站
    - 保留站项数少，一个写入一个写出，输出选择简单
    - 利用率低，忙的忙死，闲的闲死
    - 结果总线送到所有保留站

- 分组保留站: 多个功能部件共享保留站
    - 相同的功能部件共享保留站，每个保留站需要多个
    - 效率高
- 全局保留站: 所有功能部件共享保留站
    - 保留站项目很多，读/写端口很多，控制复杂
    - 效率高
    - 结果总线只送到全局保留站

### 保留站读取寄存器时机

- 保留站前读寄存器

    - 操作数没有准备好就读，保留站侦听结果总线获取没写回的值
    - 有序读寄存器
    - 保留站中有值域

- 保留站后读寄存器

    - 保留站确定所有值都准备好再读

    - 乱序读寄存器
    - 保留站中没有值域，比较简单

### 寄存器重命名技术

- 作用
    1. 异常或者猜测错误，取消后面操作
    2. 解决`WAR`, `WRW`
- 核心思想
    1. 一个操作写寄存器时重命名到其他寄存器
    2. 一个操作结束后再写到通用寄存器

### 寄存器重命名的分类

- 重命名寄存器与结构寄存器分开
    - 重命名到保留站，ROB，专门的重命名寄存器，发射队列
- 重命名寄存器与结构寄存器不分开
    - 为每个逻辑寄存器分配物理寄存器，建立两者之间的关系

## CACHE

### 特征

- Cache是主存的一个子集
- Cache没有程序上的意义 -> Cache是硬件维护的

### 结构特点

- 同时存储数据和地址
- 考虑所需的数据在不在Cache中

### Cache类型

- 全相联
- 组相连
- 直接相连

### 写命中策略

- 写穿透

    - 写cache的同时写内存

    - 内存里的数据永远是最新的，cache替换时直接扔掉
    - 只需有效位

- 写回

    - 只写cache不写内存
    - 替换时需要把cache写回内存
    - 需要脏位和有效位

- 写回/写穿透

    - L1到L2用写穿透，L2速度较快
    - L2到内存用写回，内存太慢了

### 写失效策略

- 写分配

    - 先把失效块读到cache，再在cache中写

    - 在写命中时采用写回策略的cache中使用

- 写不分配

    - 直接写入内存

    - 在写命中时采用写穿透策略的cache中使用

### Cache性能分析

- 降低失效率
- 降低失效延迟
- 降低命中延迟

#### 降低失效率

- 增加块大小
    - 降低冷失效
    - Cache容量不变的情况下，导致cache行数变少，增加冲突
- 增加Cache容量
    - 大了就快不了
- 路预测
- 软件优化

#### 失效类型

- 冷失效
- 容量失效
- 冲突失效
- 一致性失效
